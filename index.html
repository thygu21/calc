<!DOCTYPE html>
<html>
<head>
    <title>공학용 계산기 ver 1.0</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="bootstrap-3.3.2-dist/css/bootstrap.css"></link>
    <link rel="stylesheet" type="text/css" href="mine/main.css"></link>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="bootstrap-3.3.2-dist/js/bootstrap.js"></script>
    <script src='math.js' type='text/javascript'></script>
    <script type='text/javascript'>
        $(document).ready(function()
        {
            $('.qna').popover({trigger:"focus", title: "도움말", content: "도움이 필요한 버튼을 눌러보세요.", html: true, placement: "right"}); 
            $('.vector').popover({trigger:"focus", content: "<button type='button' class='btn key btn-default vectorSub procession' value='DO'>dot</button><button type='button' class='btn key btn-default vectorSub procession' value='CR'>cross</button>", html: true, placement: "right"}); 
            $('.func').popover({content: "<button type='button' class='btn key btn-default funcSub'>f()</button><button type='button' class='btn key btn-default funcSub'>g()</button>", html: true, placement: "left"}); 
            $('.variable').popover({content: "<button type='button' class='btn key btn-default variableSub pc'>x</button><button type='button' class='btn key btn-default variableSub pc'>y</button><button type='button' class='btn key btn-default variableSub pc'>z</button>", html: true, placement: "top"}); 
            let parser = math.parser();

            let displayValue = '0';
            let displayProcess = '';

            let mxrows = 2;
            let mxcols = 2;
            let rows = 1;
            let cols = 1;
            $('#result').text(displayValue);

            $(document).on("click",".procession",function(k) //토글 창 on,off , 생성된 html 팝업요소의 접근을 위한 on()사용
            {
                if(displayValue == '0') 
                    displayValue = '';

                // slice(-3,-1)은 마지막에서 세번째, 두번째 문자로 cross와 dot의 중복 클릭을 했을 때 입력을 막기 위함
                if(($(this).val() == 'DO' || $(this).val() == 'CR') && (displayValue.slice(-3,-1) != "do" || sidplayValue.slice(-3,-1) != "os")) 
                    displayValue += $(this).text();

                if($("#plustab").is(':visible'))
                {
                    $('#plustab').hide();
                }
                else
                {
                    $('#plustab').show();
                    $(".row-"+rows+".col-"+cols).focus(); // 정해진 칸에 포커스
                }

                k.stopImmediatePropagation();
            })

            $(document).on("click",".key",function(e) //키 입력, 행렬 탭이 닫혀 있을 때 동작
            {
                if(displayValue == '0') 
                    displayValue = '';

                if($("#plustab").is(':visible')) // plustab이 보일 때
                {
                    if($(this).hasClass("pc")) // 숫자+변수+기본함수 버튼을 눌렀을 때
                    {
                        displayProcess += $(this).text()
                        $(".row-"+rows+".col-"+cols).val(displayProcess);
                    }

                    if($(this).hasClass("next")) // 칸 이동
                    {
                        displayProcess = '';

                        if(cols < mxcols) //  행 이동
                            cols += 1;
                        else if(rows < mxrows) //같은 행의 숫자가 다 찼으면 한 열 아래로
                        {
                            rows += 1;
                            cols = 1;
                        }
                        else // 모든 칸이 다 찼으면 1열 1칸으로 이동
                        {
                            cols = 1
                            rows = 1
                        }
                    }

                    if($(this).hasClass("arrow")) // 행렬 칸 내에서의 지우기
                    {
                        displayProcess = remove(displayProcess);
                        $(".row-"+rows+".col-"+cols).val(displayProcess);
                    }

                    if($(this).hasClass("modify")) // 행렬 크기 조절버튼 혹은 대입 버튼을 눌렀을 때
                    {   
                        if($(this).val() == 'DN' && mxrows < 5) // 아래로 늘리기
                        {
                            mxrows += 1;
                            $("#myTable").append("<tr id='row-" + mxrows + "'></tr>");
                            $("#row-"+mxrows).append("<td>[</td>");
                            $("#row-"+mxrows).append("<td><input type='text' class='form-control key vectorInsert row-" + mxrows + " col-1' value='0'></td>");
                            for(i = 2; i <= mxcols; i++)
                            {
                                $("#row-"+mxrows).append("<td>,</td>");
                                $("#row-"+mxrows).append("<td><input type='text' class='form-control key vectorInsert row-" + mxrows + " col-" + i + "' value='0'></td>");
                            }
                            $("#row-"+mxrows).append("<td class='lastcol'>]</td>");
                            
                        }
                        else if($(this).val() == 'RI' && mxcols < 5) // 오른쪽으로 늘리기
                        {
                            $(".lastcol").remove();
                            mxcols += 1;
                            for(i = 1; i <= mxrows; i++)
                            {
                                $("#row-"+i).append("<td>,</td>");
                                $("#row-"+i).append("<td><input type='text' class='form-control key vectorInsert row-" + i + " col-" + mxcols + "' value='0'></td>");
                                $("#row-"+i).append("<td class='lastcol'>]</td>");
                            }
                        }
                        else if($(this).val() == "EN") //완성된 행렬 출력하기
                        {
                            displayValue += "(";
                            for(i = 1; i <= mxrows; i++)
                            {
                                displayValue += "[";
                                displayValue += $(".row-"+i+".col-1").val();
                                for(j = 2; j <= mxcols; j++)
                                {
                                    displayValue += ",";
                                    displayValue += $(".row-"+i+".col-"+j).val();
                                }
                                displayValue += "]";
                                displayValue += ",";
                            }
                            displayValue = displayValue.slice(0,-1); //하나 지우기(,)
                            displayValue += ")";

                            $('#result').text(displayValue);
                            $('#plustab').hide();
                        }
                    }
                }

                else if($("#plustab").is(":hidden")) // plustab이 보이지 않을 때
                {
                    
                    if($(this).val() == 'EV') // 계산하기 버튼 누를 때
                    {
                        try
                        {
                            displayValue = parser.eval(displayValue).toString();
                            let tokens = displayValue.split(' ');
                            if(tokens[0] == 'function')
                            {
                                displayValue = tokens[0];
                            }
                            $('#result').text(displayValue);                         
                            displayValue = '0';
                        }
                        catch (e)
                        {
                            displayValue = '0';
                            if(displayValue != 'function')
                            {
                                $('#result').text(e);
                            }
                        }     

                    }
                    else
                    {
                        if($(this).val() == 'CL') // 지우기 버튼을 누를 때
                        {
                            displayValue = '0';
                            $('#result').text(displayValue);
                        }
                        else if($(this).val() == 'RM') // 백스페이스 버튼을 누를 때
                        {   
                            displayValue = remove(displayValue);
                            $('#result').text(displayValue);
                        }
                        else if($(this).val() != "PR" && $(this).val() != "VE" && $(this).val() != "Help") // 벡터 와 행렬 한글을 출력하지 않게 함           
                        {        
                            displayValue += $(this).text();
                            $('#result').text(displayValue);
                        }

                    }
                    e.preventDefault();
                }
            })
        })
        function remove(display)
        {
            let context = display.slice(-3,length.display);
            // 여러 함수에 대한 한번에 지우기 처리
            if(context == "sin" || context == "cos" || context == "tan" || context == "exp" || context == "log" || context == "qrt" || context == "dot" || context == "oss")
            {
                if(context == "qrt")
                {
                    display = display.slice(0,-4);
                }
                else if(context == "oss")
                {
                    display = display.slice(0,-5);
                }
                else
                    display = display.slice(0,-3);
            }
            else // 일반 숫자나 한자리의 연산에 대한 지우기 처리
            {
                display = display.slice(0,-1);
            }
            
            return display;
        }
    </script>
</head>
 
<body>
<div class="container">
    <div class="page-header">
        <h1>공학용 계산기 ver 1.0</h1>
    </div>
    <div class="col-xs-2"> 
    </div>
    <div id="calculator" class="col-xs-6">
        <div class="row">
            <div class="col-xs-10 label">
                <textarea id="result" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-xs-2 RightLayout">
                <button type="button" class="btn key btn-danger erase" value="CL">
                    <span class="glyphicon glyphicon-erase" aria-hidden="true"></span>
                </button>
            </div>
        </div>
        <div class="row historyLine">
            <div class="col-xs-10">
                <select multiple class="form-control history">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                  </select>
            </div>
            <div class="col-xs-2 RightLayout">
                <button type="button" class="btn btn-success erase qna key" value="Help">
                    <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-9">
                <button type="button" class="btn key btn-primary vectorLeft pc">sin</button>
                <button type="button" class="btn key btn-primary vectorLeft pc">cos</button>
                <button type="button" class="btn key btn-primary vectorLeft pc">tan</button></br>
                <button type="button" class="btn key btn-info vectorLeft pc">exp</button>
                <button type="button" class="btn key btn-info vectorLeft pc">log</button>
                <button type="button" class="btn key btn-info vectorLeft pc">sqrt</button>
            </div>
            <div class="col-xs-3 RightLayout">
                <button type="button" class="btn key btn-popover procession vectorRight" value="PR">행렬<span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span></button>
                <button type="button" class="btn key btn-popover vectorRight vector" value="VE">벡터<span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span></button>
            </div>
        </div>
        <div class="row bg-warning">
            <div class="col-xs-7">
                <button type="button" class="btn btn-popover function func"><span class="glyphicon glyphicon-triangle-left" aria-hidden="true">함수</span></button>
                <button type="button" class="btn btn-popover function variable"><span class="glyphicon glyphicon-triangle-top" aria-hidden="true">변수</span></button>
            </div>
            <div class="col-xs-5">
                <button type="button" class="btn key btn-const pc">pi</button>
                <button type="button" class="btn key btn-const pc">e</button>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-6">
                <button type="button" class="btn key btn-default pc">1</button>
                <button type="button" class="btn key btn-default pc">2</button>
                <button type="button" class="btn key btn-default pc">3</button></br>
                <button type="button" class="btn key btn-default pc">4</button>
                <button type="button" class="btn key btn-default pc">5</button>
                <button type="button" class="btn key btn-default pc">6</button></br>
                <button type="button" class="btn key btn-default pc">7</button>
                <button type="button" class="btn key btn-default pc">8</button>
                <button type="button" class="btn key btn-default pc">9</button></br>
                <button type="button" class="btn key btn-primary">.</button>
                <button type="button" class="btn key btn-default pc">0</button>
                <button type="button" class="btn key btn-warning" value="EV">=</button>
                <button type="button" class="btn key btn-default bracket pc">(</button>
                <button type="button" class="btn key btn-default bracket pc">)</button>
                <button type="button" class="btn key btn-primary dot pc">,</button>
                <button type="button" class="btn key btn-default bracket pc">[</button>
                <button type="button" class="btn key btn-default bracket pc">]</button>
            </div>
            <div class="row col-xs-6 RightLayout">
                <div class="col-xs-4 ">
                    <button type="button" class="btn key btn-danger arrow" value="RM">
                        <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                    </button>
                </div>
                <div class="col-xs-8 RightLayout">
                    <button type="button" class="btn key btn-primary">+</button>
                    <button type="button" class="btn key btn-primary">-</button></br>
                    <button type="button" class="btn key btn-primary">*</button>
                    <button type="button" class="btn key btn-primary">/</button></br>
                    <button type="button" class="btn key btn-primary">%</button>
                    <button type="button" class="btn key btn-primary">^</button></br>
                </div>
            </div>
            <div>
                <button type="button" class="btn key btn-info">></button>
                <button type="button" class="btn key btn-info"><</button>
                <button type="button" class="btn key btn-info compare">==</button></br>
                <button type="button" class="btn key btn-info">>=</button>
                <button type="button" class="btn key btn-info"><=</button>
                <button type="button" class="btn key btn-info compare">!=</button>
            </div>                
        </div>
    </div>
    <div id="plustab" class="col-xs-4">
        <div class="col-xs-12 RightLayout">
            <div class="addPmeter">
                <button type="button" class="btn key btn-default modify" value="DN">
                        <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
                </button>
                <button type="button" class="btn key btn-default modify" value="RI">
                        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                </button>
            </div>
            <div>
                <button type="button" class="btn key btn-success modify enter" value="EN">입력</button>
                <button type="button" class="btn key btn-warning modify next">다음</button>
            </div>
        </div>
        <table class="table table-bordered">
            <tbody id="myTable">
                <tr id="row-1">
                    <td>[</td>
                    <td><input type="text" class="form-control key vectorInsert row-1 col-1" value="0"></td>
                    <td>,</td>
                    <td><input type="text" class="form-control key vectorInsert row-1 col-2" value="0"></td>
                    <td class="lastcol">]</td> 
                </tr>
                <tr id="row-2">
                    <td>[</td>
                    <td><input type="text" class="form-control key vectorInsert row-2 col-1" value="0"></td>
                    <td>,</td>
                    <td><input type="text" class="form-control key vectorInsert row-2 col-2" value="0"></td>
                    <td class="lastcol">]</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
</body>
</html>